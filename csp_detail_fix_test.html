<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>è¯¦æƒ…å¼¹çª—CSPä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è¯¦æƒ…å¼¹çª—CSPä¿®å¤æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„è¯¦æƒ…å¼¹çª—åŠŸèƒ½ï¼ŒéªŒè¯CSPå…¼å®¹æ€§å’Œäº‹ä»¶ç»‘å®šã€‚</p>
        
        <div class="section">
            <h2>ğŸ§ª æµ‹è¯•åŠŸèƒ½</h2>
            <button class="btn btn-primary" onclick="testDetailWindow()">æµ‹è¯•è¯¦æƒ…çª—å£åˆ›å»º</button>
            <button class="btn btn-success" onclick="testEventBinding()">æµ‹è¯•äº‹ä»¶ç»‘å®š</button>
            <button class="btn btn-warning" onclick="testCopyFunctions()">æµ‹è¯•å¤åˆ¶åŠŸèƒ½</button>
            <div id="testResults"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ“‹ æ¨¡æ‹ŸURLåˆ—è¡¨</h2>
            <p>æµ‹è¯•å°†ä½¿ç”¨ä»¥ä¸‹URLè¿›è¡ŒéªŒè¯ï¼š</p>
            <ul id="testUrls">
                <li>https://www.example.com/page1</li>
                <li>https://www.test.com/page2</li>
                <li>/relative/path/page3</li>
                <li>./current/page4</li>
            </ul>
        </div>
        
        <div class="section">
            <h2>ğŸ” è°ƒè¯•ä¿¡æ¯</h2>
            <div id="debugInfo" class="test-result info">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸBatchGetUrlToolç±»çš„æµ‹è¯•ç‰ˆæœ¬
        class BatchGetUrlToolTest {
            constructor() {
                this.extractedUrls = [
                    'https://www.example.com/page1',
                    'https://www.test.com/page2',
                    'https://www.github.com/project',
                    '/relative/path/page3',
                    './current/page4'
                ];
                console.log('æµ‹è¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ');
            }

            viewUrls() {
                console.log('æµ‹è¯•viewUrlsæ–¹æ³•');
                
                if (this.extractedUrls.length === 0) {
                    this.logTest('æ²¡æœ‰å¯æŸ¥çœ‹çš„URL', 'error');
                    return;
                }

                // åˆ›å»ºæŸ¥çœ‹çª—å£
                const viewWindow = window.open('', 'URLViewer', 'width=800,height=600,scrollbars=yes,resizable=yes');
                
                if (!viewWindow) {
                    this.logTest('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
                    return;
                }

                // æ„å»ºURLåˆ—è¡¨HTML (ä¸åŒ…å«å†…è”äº‹ä»¶)
                const urlListItems = this.extractedUrls.map((url, index) => {
                    return `<div class="url-item">
                        <span class="url-index">${index + 1}</span>
                        <a href="${url}" class="url-link" target="_blank">${url}</a>
                        <button class="copy-btn" data-url="${url}" data-index="${index}">å¤åˆ¶</button>
                    </div>`;
                }).join('');

                // ç”Ÿæˆå®Œæ•´çš„HTMLï¼ˆä¸åŒ…å«å†…è”è„šæœ¬ï¼‰
                const htmlContent = this.generateDetailHTMLWithoutInlineScript(urlListItems);
                
                try {
                    // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è®¾ç½®HTMLå†…å®¹ï¼Œé¿å…CSPé—®é¢˜
                    viewWindow.document.open();
                    viewWindow.document.write(htmlContent);
                    viewWindow.document.close();
                    
                    // ç­‰å¾…DOMåŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
                    const bindEvents = () => {
                        console.log('å¼€å§‹ç»‘å®šè¯¦æƒ…çª—å£äº‹ä»¶...');
                        this.bindDetailWindowEvents(viewWindow, this.extractedUrls);
                    };
                    
                    if (viewWindow.document.readyState === 'complete') {
                        bindEvents();
                    } else {
                        viewWindow.addEventListener('load', bindEvents);
                        // å¤‡ç”¨æ–¹æ¡ˆ
                        setTimeout(bindEvents, 100);
                    }
                    
                    this.logTest('è¯¦æƒ…çª—å£åˆ›å»ºæˆåŠŸ', 'success');
                    
                } catch (error) {
                    console.error('å†™å…¥è¯¦æƒ…çª—å£å¤±è´¥:', error);
                    console.log('å°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ³•...');
                    
                    // å…³é—­å½“å‰çª—å£å¹¶ä½¿ç”¨å¤‡ç”¨æ–¹æ³•
                    viewWindow.close();
                    this.viewUrlsAlternative();
                }
            }

            generateDetailHTMLWithoutInlineScript(urlListItems) {
                return `<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æå–çš„URLåˆ—è¡¨</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .stats { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .url-list { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .url-item { padding: 12px 15px; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; gap: 10px; }
        .url-item:last-child { border-bottom: none; }
        .url-item:hover { background: #f8f9fa; }
        .url-index { background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; min-width: 30px; text-align: center; }
        .url-link { flex: 1; word-break: break-all; color: #2980b9; text-decoration: none; }
        .url-link:hover { text-decoration: underline; }
        .copy-btn { background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .copy-btn:hover { background: #218838; }
        .actions { text-align: center; margin: 20px 0; }
        .btn { padding: 10px 20px; margin: 0 5px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; color: white; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .debug { background: #f8f9fa; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; border: 1px solid #dee2e6; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”— æå–çš„URLåˆ—è¡¨</h1>
        <p>å…±æ‰¾åˆ° ${this.extractedUrls.length} ä¸ªURL</p>
    </div>
    
    <div class="stats">
        <strong>ç»Ÿè®¡ä¿¡æ¯:</strong><br>
        æ€»æ•°é‡: ${this.extractedUrls.length}<br>
        æå–æ—¶é—´: ${new Date().toLocaleString()}
    </div>
    
    <div class="actions">
        <button class="btn btn-success" id="copyAllBtn">ğŸ“‹ å¤åˆ¶å…¨éƒ¨URL</button>
        <button class="btn btn-primary" id="exportBtn">ğŸ’¾ å¯¼å‡ºä¸ºæ–‡æœ¬</button>
        <button class="btn" id="debugBtn" style="background: #6c757d;">ğŸ” è°ƒè¯•ä¿¡æ¯</button>
    </div>
    
    <div id="debugInfo" class="debug" style="display: none;"></div>
    
    <div class="url-list">
        ${urlListItems}
    </div>
</body>
</html>`;
            }

            bindDetailWindowEvents(viewWindow, urls) {
                const doc = viewWindow.document;
                console.log('ç»‘å®šè¯¦æƒ…çª—å£äº‹ä»¶ï¼ŒURLæ•°é‡:', urls.length);
                
                // æ£€æŸ¥æ–‡æ¡£çŠ¶æ€
                console.log('æ–‡æ¡£å°±ç»ªçŠ¶æ€:', doc.readyState);
                console.log('çª—å£å¯¹è±¡å­˜åœ¨:', !!viewWindow);
                
                // ç»‘å®šå¤åˆ¶å…¨éƒ¨æŒ‰é’®
                const copyAllBtn = doc.getElementById('copyAllBtn');
                console.log('å¤åˆ¶å…¨éƒ¨æŒ‰é’®:', !!copyAllBtn);
                if (copyAllBtn) {
                    copyAllBtn.addEventListener('click', () => {
                        console.log('ç‚¹å‡»å¤åˆ¶å…¨éƒ¨æŒ‰é’®');
                        this.copyAllUrlsInDetailWindow(viewWindow, urls);
                    });
                }
                
                // ç»‘å®šå¯¼å‡ºæŒ‰é’®
                const exportBtn = doc.getElementById('exportBtn');
                console.log('å¯¼å‡ºæŒ‰é’®:', !!exportBtn);
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        console.log('ç‚¹å‡»å¯¼å‡ºæŒ‰é’®');
                        this.exportUrlsInDetailWindow(viewWindow, urls);
                    });
                }
                
                // ç»‘å®šè°ƒè¯•æŒ‰é’®
                const debugBtn = doc.getElementById('debugBtn');
                console.log('è°ƒè¯•æŒ‰é’®:', !!debugBtn);
                if (debugBtn) {
                    debugBtn.addEventListener('click', () => {
                        console.log('ç‚¹å‡»è°ƒè¯•æŒ‰é’®');
                        this.showDebugInfoInDetailWindow(viewWindow, urls);
                    });
                }
                
                // ç»‘å®šå•ä¸ªå¤åˆ¶æŒ‰é’®
                const copyBtns = doc.querySelectorAll('.copy-btn');
                console.log('å•ä¸ªå¤åˆ¶æŒ‰é’®æ•°é‡:', copyBtns.length);
                copyBtns.forEach((btn, index) => {
                    console.log(`ç»‘å®šç¬¬${index + 1}ä¸ªå¤åˆ¶æŒ‰é’®`);
                    btn.addEventListener('click', (e) => {
                        console.log('ç‚¹å‡»å•ä¸ªå¤åˆ¶æŒ‰é’®');
                        const url = e.target.getAttribute('data-url');
                        console.log('è·å–åˆ°çš„URL:', url);
                        if (url) {
                            this.copyUrlInDetailWindow(viewWindow, url);
                        } else {
                            console.error('æœªæ‰¾åˆ°data-urlå±æ€§');
                        }
                    });
                });
                
                console.log('æ‰€æœ‰äº‹ä»¶ç»‘å®šå®Œæˆ');
                this.logTest('äº‹ä»¶ç»‘å®šå®Œæˆï¼Œå…±ç»‘å®š' + (3 + copyBtns.length) + 'ä¸ªäº‹ä»¶', 'success');
            }

            copyUrlInDetailWindow(viewWindow, url) {
                console.log('å¼€å§‹å¤åˆ¶å•ä¸ªURL:', url);
                
                // æ–¹æ³•1: å°è¯•ç°ä»£å‰ªè´´æ¿API
                if (viewWindow.navigator.clipboard && viewWindow.navigator.clipboard.writeText) {
                    viewWindow.navigator.clipboard.writeText(url).then(() => {
                        console.log('å‰ªè´´æ¿APIå¤åˆ¶æˆåŠŸ');
                        viewWindow.alert('âœ… URLå·²å¤åˆ¶: ' + (url.length > 50 ? url.substring(0, 50) + '...' : url));
                        this.logTest('å‰ªè´´æ¿APIå¤åˆ¶æˆåŠŸ', 'success');
                    }).catch(err => {
                        console.error('å‰ªè´´æ¿APIå¤±è´¥:', err);
                        this.fallbackCopyInDetailWindow(viewWindow, url);
                    });
                } else {
                    console.log('å‰ªè´´æ¿APIä¸å¯ç”¨ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ');
                    this.fallbackCopyInDetailWindow(viewWindow, url);
                }
            }

            fallbackCopyInDetailWindow(viewWindow, text) {
                console.log('ä½¿ç”¨é™çº§å¤åˆ¶æ–¹æ¡ˆ');
                
                const doc = viewWindow.document;
                const textarea = doc.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                textarea.style.top = '0';
                textarea.style.opacity = '0';
                doc.body.appendChild(textarea);
                
                try {
                    textarea.focus();
                    textarea.select();
                    textarea.setSelectionRange(0, textarea.value.length);
                    
                    const successful = doc.execCommand('copy');
                    console.log('execCommandç»“æœ:', successful);
                    
                    if (successful) {
                        viewWindow.alert('âœ… å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                        this.logTest('é™çº§å¤åˆ¶æˆåŠŸ', 'success');
                    } else {
                        viewWindow.prompt('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹:', text);
                        this.logTest('é™çº§åˆ°æ‰‹åŠ¨å¤åˆ¶', 'info');
                    }
                } catch (err) {
                    console.error('execCommandå¤±è´¥:', err);
                    viewWindow.prompt('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹:', text);
                    this.logTest('å¤åˆ¶å¤±è´¥ï¼Œé™çº§åˆ°æ‰‹åŠ¨å¤åˆ¶', 'error');
                } finally {
                    doc.body.removeChild(textarea);
                }
            }

            copyAllUrlsInDetailWindow(viewWindow, urls) {
                console.log('å¼€å§‹å¤åˆ¶æ‰€æœ‰URL');
                const allUrls = urls.join('\n');
                
                if (viewWindow.navigator.clipboard && viewWindow.navigator.clipboard.writeText) {
                    viewWindow.navigator.clipboard.writeText(allUrls).then(() => {
                        console.log('æ‰¹é‡å¤åˆ¶æˆåŠŸ');
                        viewWindow.alert('âœ… æ‰€æœ‰URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆ' + urls.length + 'ä¸ªï¼Œæ¢è¡Œåˆ†éš”ï¼‰');
                        this.logTest('æ‰¹é‡å¤åˆ¶æˆåŠŸ', 'success');
                    }).catch(err => {
                        console.error('æ‰¹é‡å¤åˆ¶å¤±è´¥:', err);
                        this.fallbackCopyInDetailWindow(viewWindow, allUrls);
                    });
                } else {
                    this.fallbackCopyInDetailWindow(viewWindow, allUrls);
                }
            }

            exportUrlsInDetailWindow(viewWindow, urls) {
                console.log('å¼€å§‹å¯¼å‡ºURL');
                const content = urls.join('\n');
                
                try {
                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = viewWindow.document.createElement('a');
                    a.href = url;
                    a.download = 'extracted_urls_' + new Date().toISOString().slice(0, 10) + '.txt';
                    viewWindow.document.body.appendChild(a);
                    a.click();
                    viewWindow.document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.logTest('å¯¼å‡ºæˆåŠŸ', 'success');
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    // é™çº§æ–¹æ¡ˆï¼šåœ¨æ–°çª—å£æ˜¾ç¤ºæ–‡æœ¬
                    const textWindow = viewWindow.open('', 'ExportText', 'width=600,height=400,scrollbars=yes');
                    textWindow.document.write('<pre>' + content + '</pre>');
                    this.logTest('å¯¼å‡ºé™çº§åˆ°æ–°çª—å£æ˜¾ç¤º', 'info');
                }
            }

            showDebugInfoInDetailWindow(viewWindow, urls) {
                console.log('æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯');
                const debugInfo = viewWindow.document.getElementById('debugInfo');
                if (debugInfo) {
                    const info = `
è°ƒè¯•ä¿¡æ¯:
- URLæ•°é‡: ${urls.length}
- å½“å‰æ—¶é—´: ${new Date().toLocaleString()}
- æµè§ˆå™¨: ${navigator.userAgent}
- å‰ªè´´æ¿APIæ”¯æŒ: ${!!navigator.clipboard}
- Blob APIæ”¯æŒ: ${typeof Blob !== 'undefined'}
                    `;
                    debugInfo.textContent = info;
                    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                    this.logTest('è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º/éšè—', 'info');
                }
            }

            logTest(message, type = 'info') {
                const results = document.getElementById('testResults');
                const debug = document.getElementById('debugInfo');
                
                const result = document.createElement('div');
                result.className = `test-result ${type}`;
                result.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                if (results) {
                    results.appendChild(result);
                }
                
                if (debug) {
                    debug.textContent = `æœ€æ–°: ${message}`;
                }
            }
        }

        // åˆ›å»ºæµ‹è¯•å®ä¾‹
        const testTool = new BatchGetUrlToolTest();

        function testDetailWindow() {
            testTool.logTest('å¼€å§‹æµ‹è¯•è¯¦æƒ…çª—å£åˆ›å»º...', 'info');
            testTool.viewUrls();
        }

        function testEventBinding() {
            testTool.logTest('äº‹ä»¶ç»‘å®šæµ‹è¯•ï¼šè¯·æ‰“å¼€è¯¦æƒ…çª—å£åç‚¹å‡»å„ä¸ªæŒ‰é’®', 'info');
        }

        function testCopyFunctions() {
            testTool.logTest('å¤åˆ¶åŠŸèƒ½æµ‹è¯•ï¼šè¯·åœ¨è¯¦æƒ…çª—å£ä¸­æµ‹è¯•å¤åˆ¶æŒ‰é’®', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            testTool.logTest('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
        });
    </script>
</body>
</html>
