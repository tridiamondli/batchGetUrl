<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>XPath管理调试测试</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .test-container { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        input { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 15px; margin: 5px; }
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; 
        }
        .modal-content { background: white; padding: 20px; max-width: 500px; width: 90%; }
        .saved-xpath-item { border: 1px solid #eee; padding: 10px; margin: 5px 0; }
        .btn-tiny { padding: 4px 8px; margin: 2px; font-size: 12px; }
        .btn-use { background: #28a745; color: white; border: none; }
        .btn-delete { background: #dc3545; color: white; border: none; }
    </style>
</head>
<body>
    <h1>XPath管理调试测试</h1>
    
    <div class="test-container">
        <h3>当前XPath输入</h3>
        <input type="text" id="xpathInput" placeholder="XPath规则将显示在这里" value="//a/@href">
        <button onclick="showCurrentValue()">显示当前值</button>
    </div>
    
    <div class="test-container">
        <h3>模拟XPath管理</h3>
        <button onclick="showManageDialog()">打开管理窗口</button>
        <button onclick="testDirectUpdate()">直接测试更新</button>
    </div>
    
    <div class="test-container">
        <h3>调试信息</h3>
        <div id="debugInfo"></div>
    </div>

    <script>
        // 模拟保存的XPath数据
        const mockXPaths = {
            'test1': {
                name: 'test1',
                xpath: '//img/@src',
                createTime: Date.now() - 1000000,
                useCount: 5
            },
            'test2': {
                name: 'test2', 
                xpath: '//script/@src',
                createTime: Date.now() - 500000,
                useCount: 2
            }
        };

        function log(message) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + message + '</p>';
        }

        function showCurrentValue() {
            const input = document.getElementById('xpathInput');
            log('当前输入框值: "' + input.value + '"');
        }

        function testDirectUpdate() {
            const input = document.getElementById('xpathInput');
            const testXPath = '//div[@class="test"]/@data-url';
            
            log('开始直接更新测试');
            log('更新前值: "' + input.value + '"');
            
            input.value = testXPath;
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            
            log('更新后值: "' + input.value + '"');
        }

        function useCustomXPath(xpath, name) {
            log('调用 useCustomXPath: xpath="' + xpath + '", name="' + name + '"');
            
            const input = document.getElementById('xpathInput');
            if (!input) {
                log('错误: 找不到输入框元素');
                return;
            }
            
            log('更新前输入框值: "' + input.value + '"');
            input.value = xpath;
            log('更新后输入框值: "' + input.value + '"');
            
            // 触发事件
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            
            log('成功应用XPath规则: "' + name + '"');
            
            // 关闭模态框
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
                log('已关闭模态框');
            }
        }

        function showManageDialog() {
            log('打开管理对话框');
            
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>管理已保存的XPath规则</h3>
                    <div id="xpathList"></div>
                    <button onclick="document.querySelector('.modal').remove()">关闭</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 填充列表
            const listContainer = modal.querySelector('#xpathList');
            
            Object.entries(mockXPaths).forEach(([key, xpath]) => {
                const item = document.createElement('div');
                item.className = 'saved-xpath-item';
                item.innerHTML = `
                    <div>
                        <strong>${xpath.name}</strong><br>
                        <code>${xpath.xpath}</code><br>
                        <small>使用次数: ${xpath.useCount}</small>
                    </div>
                    <div>
                        <button class="btn-tiny btn-use" onclick="handleUseClick('${xpath.xpath}', '${xpath.name}')">使用</button>
                        <button class="btn-tiny btn-delete">删除</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            
            log('模态框已创建并显示');
        }

        function handleUseClick(xpath, name) {
            log('点击使用按钮: xpath="' + xpath + '", name="' + name + '"');
            useCustomXPath(xpath, name);
        }

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成，开始测试');
            showCurrentValue();
        });
    </script>
</body>
</html>
